"use strict";var WPForms=window.WPForms||{};WPForms.Admin=WPForms.Admin||{},WPForms.Admin.Builder=WPForms.Admin.Builder||{},WPForms.Admin.Builder.Setup=WPForms.Admin.Builder.Setup||function(a,r){var n={},s={},i={init:function(){r(i.ready),r(a).on("load",function(){"function"==typeof r.ready.then?r.ready.then(i.load):i.load()})},ready:function(){i.setup(),i.setPanelsToggleState(),i.setupTitleFocus(),i.setTriggerBlankLink(),i.events(),n.$builder.trigger("wpformsBuilderSetupReady")},load:function(){i.applyTemplateOnRequest()},setup:function(){n={$builder:r("#wpforms-builder"),$form:r("#wpforms-builder-form"),$formName:r("#wpforms-setup-name"),$panel:r("#wpforms-panel-setup"),$categories:r("#wpforms-panel-setup .wpforms-setup-templates-categories")},s.templateList=new List("wpforms-setup-templates-list",{valueNames:["wpforms-template-name","wpforms-template-desc",{name:"categories",attr:"data-categories"}]}),s.spinner='<i class="wpforms-loading-spinner wpforms-loading-white wpforms-loading-inline"></i>',s.formID=n.$form.data("id")},events:function(){n.$panel.on("keyup","#wpforms-setup-template-search",i.searchTemplate).on("click",".wpforms-setup-templates-categories li",i.selectCategory).on("click",".wpforms-template-select",i.selectTemplate).on("click",".wpforms-trigger-blank",i.selectBlankTemplate),n.$builder.on("wpformsPanelSwitched",i.setupTitleFocus),n.$builder.on("input","#wpforms-panel-field-settings-form_title",i.syncTitle).on("input","#wpforms-setup-name",i.syncTitle)},setPanelsToggleState:function(){n.$builder.find("#wpforms-panels-toggle button:not(.active)").toggleClass("wpforms-disabled",""===s.formID)},setTriggerBlankLink:function(){n.$builder.find(".wpforms-trigger-blank").attr({"data-template-name-raw":"Blank Form","data-template":"blank"})},setupTitleFocus:function(e,t){"setup"===(t=void 0===t?wpf.getQueryString("view"):t)&&n.$formName.focus()},syncTitle:function(e){("wpforms-setup-name"===e.target.id?r("#wpforms-panel-field-settings-form_title"):r("#wpforms-setup-name")).val(e.target.value)},searchTemplate:function(e){s.templateList.search(r(this).val())},selectCategory:function(e){e.preventDefault();var t=r(this),e=t.closest("ul").find(".active"),a=t.data("category");e.removeClass("active"),t.addClass("active"),s.templateList.filter(function(e){return"all"===a||-1<e.values().categories.split(",").indexOf(a)})},selectTemplate:function(e){e.preventDefault();var t=r(e.target),a=t.data("template"),e=t.data("template-name-raw"),e=n.$formName.val()||e;t.hasClass("education-modal")||(n.$panel.find(".wpforms-template").removeClass("active"),t.closest(".wpforms-template").addClass("active"),t.data("labelOriginal",t.html()),t.html(s.spinner+wpforms_builder.loading),i.applyTemplate(e,a,t))},applyTemplate:function(e,t,a){n.$builder.trigger("wpformsTemplateSelect",t),s.formID?i.selectTemplateExistingForm(e,t,a):i.selectTemplateProcess(e,t,a)},selectBlankTemplate:function(e){e.preventDefault();var t=r(e.target),e=n.$formName.val()||wpforms_builder.blank_form;i.applyTemplate(e,"blank",t)},selectTemplateExistingForm:function(e,t,a){r.confirm({title:wpforms_builder.heads_up,content:wpforms_builder.template_confirm,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action:function(){i.selectTemplateProcess(e,t,a)}},cancel:{text:wpforms_builder.cancel,action:function(){i.selectTemplateCancel()}}}})},selectTemplateProcess:function(e,t,a){a.data("addons")?i.addonsModal(e,t,a):i.selectTemplateProcessAjax(e,t)},selectTemplateCancel:function(){var e=n.$panel.find(".wpforms-template.active"),t=e.find(".wpforms-template-select");e.removeClass("active"),t.html(t.data("labelOriginal"))},selectTemplateProcessAjax:function(e,t){WPFormsBuilder.showLoadingOverlay();t={title:e,action:s.formID?"wpforms_update_form_template":"wpforms_new_form",template:t,form_id:s.formID,nonce:wpforms_builder.nonce};r.post(wpforms_builder.ajax_url,t).done(function(e){e.success?a.location.href=e.data.redirect:(wpf.debug(e),i.selectTemplateProcessError(e.data))}).fail(function(e,t,a){wpf.debug(e.responseText||t||""),i.selectTemplateProcessError("")})},selectTemplateProcessError:function(e){e=e&&e.length?"<p>"+e+"</p>":"";r.alert({title:wpforms_builder.heads_up,content:wpforms_builder.error_select_template+e,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action:function(){i.selectTemplateCancel(),WPFormsBuilder.hideLoadingOverlay()}}}})},addonsModal:function(e,t,a){var n=a.data("template-name-raw"),o=a.data("addons-names"),l=a.data("addons").split(","),a=1<l.length?wpforms_builder.template_addons_prompt:wpforms_builder.template_addon_prompt;l.length&&r.confirm({title:wpforms_builder.heads_up,content:a.replace(/%template%/g,n).replace(/%addons%/g,o),icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_education.install_confirm,btnClass:"btn-confirm",keys:["enter"],action:function(){return this.$$confirm.prop("disabled",!0).html(s.spinner+wpforms_education.activating),this.$$cancel.prop("disabled",!0),i.installActivateAddons(l,this,e,t),!1}},cancel:{text:wpforms_education.cancel,action:function(){i.selectTemplateCancel()}}}})},installActivateAddons:function(e,t,a,n){var o=[],l=[],r=!1;e.forEach(function(t){r="function"==typeof r.done?r.done(function(e){return o.push(e),i.installActivateAddonAjax(t)}).fail(function(e){l.push(e)}):i.installActivateAddonAjax(t)}),r.done(function(e){o.push(e)}).fail(function(e){l.push(e)}).always(function(){t.close(),0<o.length&&wpf.listPluck(o,"success").every(Boolean)&&0===l.length?i.selectTemplateProcessAjax(a,n):i.installActivateAddonsError(a,n)})},installActivateAddonsError:function(e,t){r.confirm({title:wpforms_builder.heads_up,content:wpforms_builder.template_addons_error,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.use_template,btnClass:"btn-confirm",keys:["enter"],action:function(){i.selectTemplateProcessAjax(e,t)}},cancel:{text:wpforms_builder.cancel,action:function(){i.selectTemplateCancel()}}}})},installActivateAddonAjax:function(e){var t=wpforms_addons[e],a=new r.Deferred;return!t||["activate","install"].indexOf(t.action)<0?(a.resolve(!1),a.promise()):r.post(wpforms_education.ajax_url,{action:"wpforms_"+t.action+"_addon",nonce:wpforms_builder.admin_nonce,plugin:"activate"===t.action?e+"/"+e+".php":t.url})},applyTemplateOnRequest:function(){var e=new URLSearchParams(a.location.search),t=e.get("template_id");"setup"===e.get("view")&&!e.get("form_id")&&t&&n.$panel.find('.wpforms-template .wpforms-btn[data-template="'+t+'"]').click()}};return i}((document,window),jQuery),WPForms.Admin.Builder.Setup.init();